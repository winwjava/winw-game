<!DOCTYPE html>
<html>
<head>
<title>winw-game</title>
<meta charset="utf-8">
<script type="text/javascript" src="/jquery-2.2.4.min.js"></script>

<script type="text/javascript" src="/echarts.min.js"></script>

</head>
<body>
	<div id="main" style="width: 100%; height: 630px; margin: 0px auto"></div>
</body>
<script>
	var chartDom = document.getElementById('main');
	var myChart = echarts.init(chartDom);
	var option;
	$.get('/SubjectIndex/getIndexQuoteList0?days=30', function(_rawData) {
		run(_rawData);
	});

	const seriesList = [];
	const datasetWithFilters = [];
	//随机颜色;
    function getRandomColor() {
    	var r = Math.floor(Math.random() * 256);
    	var g = Math.floor(Math.random() * 256);
    	var b = Math.floor(Math.random() * 256);
    	return "rgb(" + r + ',' + g + ',' + b + ")";
    }
    
    //获取随机颜色数组
    function getColor(num) {
        var colorList = [];
        for (var i = 0; i < num; i++) {
            colorList.push(getRandomColor());
        }
        return colorList;
    }
    
	function run(_rawData) {
		 var names = [];

		 for (let i = 1; i < _rawData.length; i++) {
			 if(names.indexOf(_rawData[i][2]) === -1){
				 names.push(_rawData[i][2]);
			  }
		 } 
		 console.log(names);
		 names.forEach(function(_item) {
			var datasetId = 'dataset_' + _item;
			 datasetWithFilters.push({
				id : datasetId,
				fromDatasetId : 'dataset_raw',
			 transform: {
			  type: 'filter',
			  config: {
			    and: [
			      { dimension: 'name', '=': _item }
			    ]
			  }
			} 
			}); 
			seriesList.push({
				type : 'line',
				datasetId : datasetId,
				showSymbol : false,
				name : _item,
				 endLabel : {
					show : true,
					formatter : function(params) {
						return params[2];
					}
				}, 
				labelLayout : {
					moveOverlap : 'shiftY'
				},
				emphasis : {
					focus : 'series'
				},
				encode : {
					x : 'date',
					y : 'close',
					label : [ 'name', 'close' ],
					itemName : 'date',
					tooltip : [ 'close' ]
				}
			});
		});

		  option = {
		    animationDuration: 0,
		    dataset: [
		      {
		        id: 'dataset_raw',
		        source: _rawData
		      },
		      ...datasetWithFilters
		    ],
		    //title: {
		      //text: 'Trend of Subject Index '
		    //},
		    tooltip: {// 鼠标滑过的提示框
		     // order: 'valueDesc',
		     // trigger: 'axis'
		    },
		    xAxis: {
		      type: 'category',
		      nameLocation: 'middle'
		    },
		    yAxis: {
		      name: 'Change'
		    },
		    grid: {
		      //right: 140,
	            top: '1%',  
	            left: '1%', 
	            right: '8%',
	            bottom: '1%',
	            containLabel: true
		    },
		    series: seriesList,
		    color: getColor(20)
		  };
		  myChart.setOption(option);
		  // https://www.csindex.com.cn/#/indices/family/detail?indexCode=930633
	}
</script>
</html>